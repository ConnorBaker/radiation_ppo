cluster_name: aws-cluster

max_workers: 15
# Agressively kill idle nodes
idle_timeout_minutes: 2
# Scales up by upscaling_speed*current number of nodes.
# With the default of 1.0, the cluster doubles every time
# it needs to scale. We use 2.0 so it quadruples (helpful for initial loading).
upscaling_speed: 2.0

provider:
  type: aws
  region: us-east-2
  cache_stopped_nodes: false

auth:
  ssh_user: ec2-user # Username for Amazon Linux 2022

available_node_types:
  ray.head.default:
    node_config:
      InstanceType: m5n.4xlarge
      # aws ec2 describe-images --filters "Name=name,Values=al2022-ami-2022.0.202205*kernel-5.15*"
      ImageId: ami-04a0a1bfbe6cb2189 # Amazon Linux 2022 -- can't use minimal since we need rsync
    resources: {}
  # Multiple types of nodes can be specified by following
  # https://github.com/ray-project/ray/blob/master/python/ray/autoscaler/aws/example-multi-node-type.yaml
  ray.worker.default:
    node_config:
      # Pricing is consistent over the last three months for us-east-2.
      # No need to specify particular availability zones.
      InstanceType: c6a.4xlarge
      ImageId: ami-04a0a1bfbe6cb2189 # Amazon Linux 2022 -- can't use minimal since we need rsync
      InstanceMarketOptions:
        MarketType: spot
    resources: {}

setup_commands:
  # Let's make a ramdisk!
  - |
    cd /home && \
      sudo mv $USER tmp && \
      sudo mkdir $USER && \
      sudo mount -t tmpfs tmpfs $USER && \
      sudo chmod 700 $USER && \
      sudo cp -a tmp/. $USER && \
      sudo rm -rf tmp
  # Install mamba
  - curl -LO https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh
  - bash Mambaforge-Linux-x86_64.sh -b
  - rm Mambaforge-Linux-x86_64.sh
  # Ray looks for conda specifically, so we use a symbolic link to get it to use mamba
  - sudo ln -s ~/mambaforge/bin/mamba /usr/local/bin/conda
  - sudo ln -s ~/mambaforge/bin/mamba /usr/local/bin/mamba
  - mamba init
  - mamba config --set auto_activate_base True
  # Install our python and ray nightly
  - mamba install --yes conda-forge::{python=3.9,pip}
  - pip install 'ray[all] @ https://s3-us-west-2.amazonaws.com/ray-wheels/master/010a3566e68fd066cecbb88328e720dde3f1b059/ray-3.0.0.dev0-cp39-cp39-manylinux2014_x86_64.whl'
